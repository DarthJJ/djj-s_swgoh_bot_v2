package nl.djj.swgoh_bot_v2.helpers;

import net.dv8tion.jda.api.EmbedBuilder;
import net.dv8tion.jda.api.entities.MessageEmbed;
import nl.djj.swgoh_bot_v2.commands.BaseCommand;
import nl.djj.swgoh_bot_v2.config.Config;
import nl.djj.swgoh_bot_v2.entities.Flag;
import nl.djj.swgoh_bot_v2.entities.Message;
import nl.djj.swgoh_bot_v2.entities.SwgohProfile;

import java.awt.*;
import java.time.ZonedDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

/**
 * @author DJJ
 */
//CHECKSTYLE.OFF: MultipleStringLiteralsCheck
public final class MessageHelper {
    private static final String REACTION_POSITIVE = "U+1F44D";
    private static final String REACTION_ERROR = "U+274C";
    private static final String REACTION_DONE = "U+2705";
    private static final String TABLE_FORMAT = "%-15s%-3s%-15s%n";

    /**
     * Constructor.
     */
    private MessageHelper() {
        super();
    }

    private static MessageEmbed baseEmbed() {
        final EmbedBuilder builder = new EmbedBuilder();
        builder.setAuthor(Config.BOT_NAME, "https://www.youtube.com/watch?v=YddwkMJG1Jo", "https://cdn.discordapp.com/avatars/405842805441822721/83e13c25144df2db31aa963083e6dc40.png");
        builder.setColor(new Color(Config.BOT_COLOUR));
        builder.setTimestamp(ZonedDateTime.now());
        builder.setFooter("Generated by: " + Config.BOT_NAME);
        return builder.build();
    }

    /**
     * Sends a working reaction to the message.
     *
     * @param message the message.
     */
    public static void addWorkingReaction(final Message message) {
        message.getChannel().addReactionById(message.getMessageId(), REACTION_POSITIVE).queue();
    }

    /**
     * Sends an error reaction to the message.
     *
     * @param message the message.
     */
    public static void addErrorReaction(final Message message) {
        message.getChannel().addReactionById(message.getMessageId(), REACTION_ERROR).queue();
    }

    /**
     * Sends a positive reaction to the message.
     *
     * @param message the message.
     */
    public static void addDoneReaction(final Message message) {
        message.getChannel().addReactionById(message.getMessageId(), REACTION_DONE).queue();
    }

    /**
     * Creates the generic help text.
     *
     * @param helpText the help text.
     * @return the messageEmbed.
     */
    public static List<MessageEmbed> formatGenericHelpText(final Map<String, List<BaseCommand>> helpText) {
        final List<MessageEmbed> returnValue = new ArrayList<>();
        EmbedBuilder builder = new EmbedBuilder(baseEmbed());
        builder.appendDescription("Generic help information");
        for (final Map.Entry<String, List<BaseCommand>> entry : helpText.entrySet()) {
            final StringBuilder helpString = new StringBuilder();
            for (final BaseCommand command : entry.getValue()) {
                helpString.append(String.format(TABLE_FORMAT, command.getName(), " = ", command.getDescription()));
            }
            helpString.append("\n");
            builder.addField(new MessageEmbed.Field(entry.getKey(), helpString.toString(), false));
            if (builder.length() >= MessageEmbed.EMBED_MAX_LENGTH_BOT - 500) {
                returnValue.add(builder.build());
                builder = new EmbedBuilder(baseEmbed());
            }
        }
        returnValue.add(builder.build());
        return returnValue;
    }

    /**
     * Formats the info to an embed.
     *
     * @param profile the profile.
     * @return a message embed.
     */
    public static MessageEmbed formatSwgohProfile(final SwgohProfile profile) {
        final EmbedBuilder builder = new EmbedBuilder(baseEmbed());
        builder.appendDescription("Generic Profile info for: " + profile.getName());
        final String generic = String.format(TABLE_FORMAT, "Level", "=", profile.getLevel()) +
                String.format(TABLE_FORMAT, "Guild", "=", profile.getGuild());
        builder.addField(new MessageEmbed.Field("Generic", "```" + generic + "```", false));
        final String gp = String.format(TABLE_FORMAT, "GP_total", "=", profile.getGpTotal()) +
                String.format(TABLE_FORMAT, "GP toons", "=", profile.getGpToons()) +
                String.format(TABLE_FORMAT, "GP ships", "=", profile.getGpShips());
        builder.addField(new MessageEmbed.Field("GP", "```" + gp + "```", false));
        final String arena = String.format(TABLE_FORMAT, "Toon Arena", "=", profile.getToonRank()) +
                String.format(TABLE_FORMAT, "Ship Arena", "=", profile.getShipRank());
        builder.addField(new MessageEmbed.Field("Arena", "```" + arena + "```", false));
        final String profileLink = String.format(TABLE_FORMAT, "SWGOH profile", "", "[Link](" + profile.getProfileUrl() + ")");
        builder.addField(new MessageEmbed.Field("SWGOH", profileLink, false));
        builder.addField(new MessageEmbed.Field("Updated:", profile.getLastUpdated().toString(), false));
        return builder.build();
    }

    /**
     * Generates a specific help text.
     *
     * @param name        the command.
     * @param description the description.
     * @param flags       the flags.
     * @return an embed.
     */
    public static MessageEmbed formatSpecificHelpText(final String name, final String description, final Map<String, Flag> flags, final String prefix) {
        final EmbedBuilder builder = new EmbedBuilder(baseEmbed());
        builder.appendDescription("Info for command: " + name);
        builder.addField("Description", description, false);
        if (!flags.isEmpty()) {
            for (final Map.Entry<String, Flag> entry : flags.entrySet()) {
                final String flagText = String.format(TABLE_FORMAT, "Description", "=", entry.getValue().getDescription()) +
                        String.format(TABLE_FORMAT, "Usage", "=", prefix + entry.getValue().getHelpText());
                builder.addField(entry.getValue().getName(), "```" + flagText + "```", false);
            }
        }
        return builder.build();
    }

    /**
     * Creates an embed for the Arena profile.
     *
     * @param profile the profile.
     * @return the embed.
     */
    public static MessageEmbed formatArenaProfile(final SwgohProfile profile) {
        final EmbedBuilder builder = new EmbedBuilder(baseEmbed());
        builder.appendDescription("Arena info for: " + profile.getName());
        final StringBuilder toonArena = new StringBuilder();
        for (final String s : profile.getToonArenaTeam()) {
            toonArena.append(s).append("\n");
        }
        builder.addField(new MessageEmbed.Field("Toon Arena Rank: ", Integer.toString(profile.getToonArenaRank()), false));
        builder.addField(new MessageEmbed.Field("Toon Arena Team", "```" + toonArena + "```", false));
        final StringBuilder shipArena = new StringBuilder();
        for (final String s : profile.getShipArenaTeam()) {
            shipArena.append(s).append("\n");
        }
        builder.addField(new MessageEmbed.Field("Toon Arena Rank: ", Integer.toString(profile.getShipArenaRank()), false));
        builder.addField(new MessageEmbed.Field("Toon Arena Team", "```" + shipArena + "```", false));
        builder.addField(new MessageEmbed.Field("Updated at: ", profile.getLastUpdated().toString(), false));
        return builder.build();
    }
    //CHECKSTYLE.ON: MultipleStringLiteralsCheck
}
